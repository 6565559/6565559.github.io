<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾¤èŠæ—¥æŠ¥ by ChatInsight</title>
     <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%234f46e5'/%3E%3Cstop offset='100%25' stop-color='%2306b6d4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E%3Cpath d='M16 20h32a6 6 0 016 6v10a6 6 0 01-6 6H28l-8 8v-8h-4a6 6 0 01-6-6V26a6 6 0 016-6z' fill='%23ffffff' opacity='0.92'/%3E%3Ccircle cx='24' cy='32' r='3' fill='%234f46e5'/%3E%3Ccircle cx='32' cy='32' r='3' fill='%234f46e5'/%3E%3Ccircle cx='40' cy='32' r='3' fill='%234f46e5'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%234f46e5'/%3E%3Cstop offset='100%25' stop-color='%2306b6d4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E%3Cpath d='M16 20h32a6 6 0 016 6v10a6 6 0 01-6 6H28l-8 8v-8h-4a6 6 0 01-6-6V26a6 6 0 016-6z' fill='%23ffffff' opacity='0.92'/%3E%3Ccircle cx='24' cy='32' r='3' fill='%234f46e5'/%3E%3Ccircle cx='32' cy='32' r='3' fill='%234f46e5'/%3E%3Ccircle cx='40' cy='32' r='3' fill='%234f46e5'/%3E%3C/svg%3E">

    <!-- æœ¬åœ°æ ·å¼æ–‡ä»¶ï¼ˆæ•´åˆäº†ä¸»é¢˜åˆ‡æ¢æ ·å¼ï¼‰ -->
    
    <!-- æœ¬åœ°è„šæœ¬æ–‡ä»¶ï¼ˆæ•´åˆäº†æ¸²æŸ“å™¨å’Œä¸»é¢˜åˆ‡æ¢é€»è¾‘ï¼‰ -->
     <!-- <link rel="stylesheet" href="style.css">
    <script src="script.js"></script> -->

    

     <!-- è¯äº‘åº“ï¼šä¸“ä¸šçš„è¯äº‘å¸ƒå±€ç®—æ³• -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

    <!-- Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/6565559/6565559.github.io@main/static/style-v1.3.css"> 
    <script src="https://cdn.jsdelivr.net/gh/6565559/6565559.github.io@main/static/script-v1.3.js"></script>

</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢å¼€å…³ -->
    <div class="theme-toggle-wrapper">
        <div class="theme-toggle" id="theme-toggle" role="switch" aria-label="åˆ‡æ¢ä¸»é¢˜">
            <div class="theme-toggle-slider">
                <svg id="theme-icon" viewBox="0 0 24 24">
                    <!-- å›¾æ ‡ä¼šæ ¹æ®ä¸»é¢˜åŠ¨æ€åˆ‡æ¢ -->
                </svg>
            </div>
        </div>
    </div>

    <!-- å†å²æ—¥æŠ¥æŒ‰é’® -->
    <div class="history-toggle-wrapper">
        <button class="history-btn" id="history-btn" aria-label="æŸ¥çœ‹å†å²æ—¥æŠ¥">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span>å†å²</span>
        </button>
    </div>

    <!-- å†å²æ—¥æŠ¥ä¾§è¾¹æ  -->
    <div class="history-sidebar" id="history-sidebar">
        <div class="history-header">
            <h3>ğŸ“š å†å²æ—¥æŠ¥</h3>
            <button class="close-btn" id="close-history-btn" aria-label="å…³é—­">Ã—</button>
        </div>
        <div class="history-list" id="history-list">
            <!-- åŠ¨æ€ç”Ÿæˆå†å²åˆ—è¡¨ -->
        </div>
    </div>

    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>

    <div class="container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <header id="report-header">
            <!-- JSåŠ¨æ€ç”Ÿæˆ -->
        </header>

        <!-- 1. è®¨è®ºçƒ­ç‚¹ -->
        <section class="hot-topics">
            <h2 id="hot-topics-title">ğŸ“Š è®¨è®ºçƒ­ç‚¹</h2>
            <div class="card-grid card-grid-2" id="hot-topics-container">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- 2. å®ç”¨æ•™ç¨‹ä¸èµ„æºåˆ†äº« -->
        <section class="tutorials">
            <h2>ğŸ“š å®ç”¨æ•™ç¨‹ä¸èµ„æºåˆ†äº«</h2>
            <div class="card-grid card-grid-3" id="shared-resources-container">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- 5. é—®ç­”ç²¾é€‰ -->
        <section class="questions-answers">
            <h2>â“ é—®ç­”ç²¾é€‰</h2>
            <div class="card-grid card-grid-1" id="qa-highlights-container">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- 6. æ•°æ®ç»Ÿè®¡ä¸å¯è§†åŒ– -->
        <section class="analytics">
            <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡ä¸åˆ†æ</h2>
            
            <!-- è¯é¢˜çƒ­åº¦åˆ†å¸ƒ -->
            <h3>ğŸ”¥ è¯é¢˜çƒ­åº¦åˆ†å¸ƒ</h3>
            <div class="heat-distribution" id="heat-distribution-container">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æ´»è·ƒåº¦æ’è¡Œæ¦œ -->
            <h3>ğŸ† æ´»è·ƒåº¦æ’è¡Œæ¦œ</h3>
            <div class="participants-ranking" id="activity-ranking-container">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æ—¶æ®µæ´»è·ƒåº¦åˆ†æ -->
            <h3>â° æ—¶æ®µæ´»è·ƒåº¦åˆ†æ</h3>
            <div class="time-activity">
                <div class="time-chart" id="hourly-activity-chart">
                    <!-- JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- ç†¬å¤œå† å†› -->
            <div id="night-owl-section">
                 <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- 7. è¯äº‘å±•ç¤º -->
        <section class="word-cloud">
            <h2>â˜ï¸ çƒ­è¯äº‘å›¾</h2>
            <div class="cloud-container" id="word-cloud-container">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- 8. æŠ¥å‘Šæ€»ç»“ -->
        <section class="summary">
            <h2 id="summary-title">ğŸ“ æ€»ç»“</h2>
            <div class="card" id="report-summary-container">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
        
        <!-- é¡µè„šä¿¡æ¯ -->
        <footer id="report-footer">
            <!-- JSåŠ¨æ€ç”Ÿæˆ -->
        </footer>
    </div>

    <script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://zkjzpqycxwcotdpipjxm.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_Sftz8O0zjTHSVoyETwP3Lg_FYp6Xh4v';

    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /**
     * HTMLæ¨¡æ¿å·¥å‚ - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰HTMLæ¨¡æ¿
     */
    const TemplateFactory = {
        /**
         * åˆ›å»ºæ—¥æŠ¥å®¹å™¨å¸ƒå±€
         * @returns {string} å®Œæ•´çš„æ—¥æŠ¥HTMLç»“æ„
         */
        createReportLayout() {
            return `
                <header id="report-header"></header>
                <section class="hot-topics">
                    <h2 id="hot-topics-title">ğŸ“Š è®¨è®ºçƒ­ç‚¹</h2>
                    <div class="card-grid card-grid-2" id="hot-topics-container"></div>
                </section>
                <section class="tutorials">
                    <h2>ğŸ“š å®ç”¨æ•™ç¨‹ä¸èµ„æºåˆ†äº«</h2>
                    <div class="card-grid card-grid-3" id="shared-resources-container"></div>
                </section>
                <section class="questions-answers">
                    <h2>â“ é—®ç­”ç²¾é€‰</h2>
                    <div class="card-grid card-grid-1" id="qa-highlights-container"></div>
                </section>
                <section class="analytics">
                    <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡ä¸åˆ†æ</h2>
                    <h3>ğŸ”¥ è¯é¢˜çƒ­åº¦åˆ†å¸ƒ</h3>
                    <div class="heat-distribution" id="heat-distribution-container"></div>
                    <h3>ğŸ† æ´»è·ƒåº¦æ’è¡Œæ¦œ</h3>
                    <div class="participants-ranking" id="activity-ranking-container"></div>
                    <h3>â° æ—¶æ®µæ´»è·ƒåº¦åˆ†æ</h3>
                    <div class="time-activity">
                        <div class="time-chart" id="hourly-activity-chart"></div>
                    </div>
                    <div id="night-owl-section"></div>
                </section>
                <section class="word-cloud">
                    <h2>â˜ï¸ çƒ­è¯äº‘å›¾</h2>
                    <div class="cloud-container" id="word-cloud-container"></div>
                </section>
                <section class="summary">
                    <h2 id="summary-title">ğŸ“ æ€»ç»“</h2>
                    <div class="card" id="report-summary-container"></div>
                </section>
                <footer id="report-footer"></footer>
            `;
        },

        /**
         * åˆ›å»ºåŠ è½½ä¸­UI
         * @returns {string} åŠ è½½ä¸­çš„HTML
         */
        createLoadingUI() {
            return `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </div>
            `;
        },

        /**
         * åˆ›å»ºé”™è¯¯UI
         * @param {string} message - é”™è¯¯ä¿¡æ¯
         * @returns {string} é”™è¯¯æç¤ºçš„HTML
         */
        createErrorUI(message) {
            return `
                <div class="error-container">
                    <div class="error-icon">âš ï¸</div>
                    <p>${message}</p>
                </div>
            `;
        }
    };

    /**
     * ä¾§è¾¹æ ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†ä¾§è¾¹æ çŠ¶æ€å’Œæ“ä½œ
     */
    class SidebarManager {
        constructor(sidebarId, overlayId, listId) {
            this.sidebar = document.getElementById(sidebarId);
            this.overlay = document.getElementById(overlayId);
            this.list = document.getElementById(listId);
        }

        /**
         * æ˜¾ç¤ºä¾§è¾¹æ 
         */
        show() {
            // æ¯æ¬¡æ‰“å¼€æ—¶é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼Œç¡®ä¿é€‰ä¸­çŠ¶æ€æ­£ç¡®
            this.renderList();

            this.sidebar.classList.add('active');
            this.overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        /**
         * å…³é—­ä¾§è¾¹æ 
         */
        close() {
            this.sidebar.classList.remove('active');
            this.overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        /**
         * åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
         */
        toggle() {
            if (this.sidebar.classList.contains('active')) {
                this.close();
            } else {
                this.show();
            }
        }

        /**
         * æ¸²æŸ“å†å²æ—¥æŠ¥åˆ—è¡¨
         */
        renderList() {
            if (!historyReports || historyReports.length === 0) {
                this.list.innerHTML = '<div class="empty-state">æš‚æ— å†å²æ—¥æŠ¥</div>';
                return;
            }

            const listHTML = historyReports.map((report, index) => {
                const isNewest = index === 0;
                const isCurrent = report.id === currentReportId;
                const date = new Date(report.report_date || report.created_at);
                const groupName = report.report_data?.reportInfo?.groupName || 'æœªçŸ¥ç¾¤ç»„';

                return `
                    <div class="history-item ${isCurrent ? 'active' : ''}"
                         data-report-id="${report.id}"
                         onclick="loadReportById(${report.id})">
                        <div class="history-item-header">
                            <span class="history-date">${date.toLocaleDateString('zh-CN')}</span>
                            ${isNewest ? '<span class="new-badge">NEW</span>' : ''}
                        </div>
                        <div class="history-item-title">${groupName}</div>
                        <div class="history-item-meta">
                            <span>ğŸ“Š ${report.report_data?.reportInfo?.totalMessages || 0} æ¡æ¶ˆæ¯</span>
                            <span>ğŸ‘¥ ${report.report_data?.reportInfo?.activeUsers || 0} æ´»è·ƒ</span>
                        </div>
                    </div>
                `;
            }).join('');

            this.list.innerHTML = listHTML;
        }
    }

    // åˆ›å»ºå†å²ä¾§è¾¹æ ç®¡ç†å™¨å®ä¾‹
    const historySidebar = new SidebarManager('history-sidebar', 'overlay', 'history-list');

    /**
     * æ•°æ®æ˜ å°„å™¨ - ç»Ÿä¸€å¤„ç†æ•°æ®åº“å­—æ®µæ˜ å°„
     */
    const DataMapper = {
        /**
         * å°†æ•°æ®åº“å­—æ®µé™„åŠ åˆ°æŠ¥å‘Šæ•°æ®
         * @param {Object} reportData - æŠ¥å‘Šæ•°æ®å¯¹è±¡
         * @param {Object} dbRecord - æ•°æ®åº“è®°å½•å¯¹è±¡
         * @returns {Object} é™„åŠ äº†æ•°æ®åº“å­—æ®µçš„æŠ¥å‘Šæ•°æ®
         */
        attachDBFields(reportData, dbRecord) {
            reportData._dbFields = {
                reportDate: dbRecord.report_date,
                createdAt: dbRecord.created_at
            };
            return reportData;
        },

        /**
         * ä»æ•°æ®åº“è®°å½•ä¸­æå–å¹¶æ˜ å°„æŠ¥å‘Šæ•°æ®
         * @param {Object} dbRecord - æ•°æ®åº“è®°å½•å¯¹è±¡
         * @returns {Object} åŒ…å«æ•°æ®åº“å­—æ®µçš„æŠ¥å‘Šæ•°æ®
         */
        extractReportData(dbRecord) {
            const reportData = dbRecord.report_data;
            return this.attachDBFields(reportData, dbRecord);
        }
    };

    // å…¨å±€å˜é‡ï¼šå­˜å‚¨å½“å‰æ˜¾ç¤ºçš„æ—¥æŠ¥ID
    let currentReportId = null;
    let historyReports = [];

    /**
     * ä» Supabase æŸ¥è¯¢æœ€æ–°çš„æ—¥æŠ¥æ•°æ®
     * @returns {Promise<Object|null>} æ—¥æŠ¥æ•°æ®æˆ– null
     */
    async function fetchLatestReport() {
        try {
            console.log('ğŸ“¡ å¼€å§‹ä» Supabase è·å–æœ€æ–°æ—¥æŠ¥æ•°æ®...');

            const { data, error } = await supabase
                .from('report_info')
                .select('*')
                .order('report_date', { ascending: false })
                .limit(1)
                .single();

            if (error) {
                throw error;
            }

            if (!data) {
                throw new Error('æœªæ‰¾åˆ°æ—¥æŠ¥æ•°æ®');
            }

            console.log('âœ… æˆåŠŸè·å–æ—¥æŠ¥æ•°æ®:', data);

            // ä¿å­˜å½“å‰æ—¥æŠ¥ID
            currentReportId = data.id;

            // ä»æ•°æ®åº“è®°å½•ä¸­æå– report_data JSON å­—æ®µï¼Œå¹¶é™„åŠ æ•°æ®åº“å­—æ®µ
            const reportData = DataMapper.extractReportData(data);

            return reportData;

        } catch (error) {
            console.error('âŒ è·å–æ—¥æŠ¥æ•°æ®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * ä» Supabase æŸ¥è¯¢æœ€è¿‘10æ¡æ—¥æŠ¥æ•°æ®
     * @returns {Promise<Array>} æ—¥æŠ¥æ•°æ®æ•°ç»„
     */
    async function fetchRecentReports() {
        try {
            console.log('ğŸ“¡ å¼€å§‹è·å–æœ€è¿‘10æ¡æ—¥æŠ¥æ•°æ®...');

            const { data, error } = await supabase
                .from('report_info')
                .select('id, created_at, report_date, report_type, report_data')
                .order('report_date', { ascending: false })
                .limit(10);

            if (error) {
                throw error;
            }

            console.log('âœ… æˆåŠŸè·å–å†å²æ—¥æŠ¥:', data);
            historyReports = data || [];
            return historyReports;

        } catch (error) {
            console.error('âŒ è·å–å†å²æ—¥æŠ¥å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * æ ¹æ®IDåŠ è½½ç‰¹å®šæ—¥æŠ¥
     * @param {number} reportId - æ—¥æŠ¥ID
     */
    async function loadReportById(reportId) {
        try {
            showLoading();

            const report = historyReports.find(r => r.id === reportId);
            if (!report) {
                throw new Error('æœªæ‰¾åˆ°æŒ‡å®šæ—¥æŠ¥');
            }

            currentReportId = reportId;

            // é™„åŠ æ•°æ®åº“å­—æ®µåˆ°æŠ¥å‘Šæ•°æ®
            const reportData = DataMapper.extractReportData(report);

            // é‡æ–°æ„å»ºå®¹å™¨ç»“æ„
            const container = document.querySelector('.container');
            container.innerHTML = TemplateFactory.createReportLayout();

            // åˆå§‹åŒ–æ¸²æŸ“å™¨
            ChatLogRenderer.init(reportData);

            // å…³é—­ä¾§è¾¹æ 
            historySidebar.close();

            console.log('ğŸ‰ æ—¥æŠ¥åˆ‡æ¢å®Œæˆï¼');

        } catch (error) {
            console.error('âŒ åŠ è½½æ—¥æŠ¥å¤±è´¥:', error);
            showError(error.message || 'åŠ è½½æ—¥æŠ¥å¤±è´¥');
        }
    }

    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    function showLoading() {
        const container = document.querySelector('.container');
        if (container) {
            container.innerHTML = `
                <div class="loading-wrapper">
                    <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring"></div>
                    </div>
                    <h2 class="loading-title">æ­£åœ¨åŠ è½½æ—¥æŠ¥æ•°æ®</h2>
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <style>
                    .loading-wrapper {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        min-height: 60vh;
                        padding: 40px 20px;
                        background: var(--color-bg-primary);
                    }

                    .loading-spinner {
                        position: relative;
                        width: 80px;
                        height: 80px;
                        filter: drop-shadow(var(--shadow-glow));
                    }

                    .spinner-ring {
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        border: 3px solid transparent;
                        border-radius: 50%;
                        animation: spin 1.5s cubic-bezier(0.5, 0, 0.5, 1) infinite;
                    }

                    .spinner-ring:nth-child(1) {
                        border-top-color: var(--color-primary);
                        animation-delay: -0.45s;
                    }

                    .spinner-ring:nth-child(2) {
                        border-top-color: var(--color-secondary);
                        animation-delay: -0.3s;
                    }

                    .spinner-ring:nth-child(3) {
                        border-top-color: var(--color-primary-light);
                        animation-delay: -0.15s;
                    }

                    @keyframes spin {
                        0% {
                            transform: rotate(0deg);
                        }
                        100% {
                            transform: rotate(360deg);
                        }
                    }

                    .loading-title {
                        margin-top: 32px;
                        color: var(--color-text-primary);
                        font-size: 20px;
                        font-weight: 600;
                        letter-spacing: -0.02em;
                        background: var(--gradient-primary);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                    }

                    .loading-dots {
                        display: flex;
                        gap: 8px;
                        margin-top: 16px;
                    }

                    .loading-dots span {
                        width: 8px;
                        height: 8px;
                        background: var(--gradient-primary);
                        border-radius: 50%;
                        animation: pulse 1.4s ease-in-out infinite;
                        box-shadow: 0 0 10px var(--color-primary);
                    }

                    .loading-dots span:nth-child(1) {
                        animation-delay: 0s;
                    }

                    .loading-dots span:nth-child(2) {
                        animation-delay: 0.2s;
                        background: var(--color-secondary);
                        box-shadow: 0 0 10px var(--color-secondary);
                    }

                    .loading-dots span:nth-child(3) {
                        animation-delay: 0.4s;
                        background: var(--color-primary-light);
                        box-shadow: 0 0 10px var(--color-primary-light);
                    }

                    @keyframes pulse {
                        0%, 80%, 100% {
                            transform: scale(0.6);
                            opacity: 0.5;
                        }
                        40% {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }
                </style>
            `;
        }
    }

    /**
     * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
     */
    function showError(errorMessage) {
        const container = document.querySelector('.container');
        if (container) {
            container.innerHTML = `
                <div class="error-wrapper">
                    <div class="error-icon">âš ï¸</div>
                    <h2 class="error-title">åŠ è½½å¤±è´¥</h2>
                    <p class="error-message">${errorMessage}</p>
                    <div class="error-suggestions">
                        <h3>å»ºè®®æ“ä½œï¼š</h3>
                        <ul>
                            <li>ğŸŒ æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                            <li>âš™ï¸ ç¡®è®¤ Supabase é…ç½®æ­£ç¡®</li>
                            <li>ğŸ” æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                            <li>ğŸ”„ å°è¯•åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½</li>
                        </ul>
                    </div>
                    <button class="btn-retry" onclick="location.reload()">
                        <span>ğŸ”„</span>
                        <span>é‡æ–°åŠ è½½</span>
                    </button>
                </div>
                <style>
                    .error-wrapper {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        min-height: 60vh;
                        padding: 40px 20px;
                        text-align: center;
                        background: var(--color-bg-primary);
                    }

                    .error-icon {
                        font-size: 80px;
                        margin-bottom: 20px;
                        animation: shake 0.5s ease-in-out;
                    }

                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                        20%, 40%, 60%, 80% { transform: translateX(10px); }
                    }

                    .error-title {
                        font-size: 32px;
                        font-weight: 700;
                        color: var(--color-error);
                        margin-bottom: 16px;
                        letter-spacing: -0.02em;
                    }

                    .error-message {
                        font-size: 17px;
                        color: var(--color-text-secondary);
                        margin-bottom: 32px;
                        max-width: 600px;
                        line-height: 1.6;
                    }

                    .error-suggestions {
                        background: var(--color-bg-elevated);
                        border-radius: var(--radius-lg);
                        padding: 24px 32px;
                        margin-bottom: 32px;
                        box-shadow: var(--shadow-sm);
                        max-width: 500px;
                    }

                    .error-suggestions h3 {
                        font-size: 17px;
                        font-weight: 600;
                        color: var(--color-text-primary);
                        margin-bottom: 16px;
                        text-align: left;
                    }

                    .error-suggestions ul {
                        list-style: none;
                        padding: 0;
                        margin: 0;
                    }

                    .error-suggestions li {
                        padding: 10px 0;
                        color: var(--color-text-secondary);
                        text-align: left;
                        font-size: 15px;
                        border-bottom: 1px solid var(--color-separator);
                    }

                    .error-suggestions li:last-child {
                        border-bottom: none;
                    }

                    .btn-retry {
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        padding: 14px 32px;
                        background: var(--gradient-primary);
                        color: white;
                        border: none;
                        border-radius: var(--radius-md);
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: var(--shadow-sm);
                    }

                    .btn-retry:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-md), var(--shadow-glow);
                    }

                    .btn-retry:active {
                        transform: translateY(0);
                    }
                </style>
            `;
        }
    }

    /**
     * æ˜¾ç¤ºå†å²æ—¥æŠ¥ä¾§è¾¹æ 
     * @deprecated è¯·ä½¿ç”¨ historySidebar.show()
     */
    function showHistorySidebar() {
        historySidebar.show();
    }

    /**
     * å…³é—­å†å²æ—¥æŠ¥ä¾§è¾¹æ 
     * @deprecated è¯·ä½¿ç”¨ historySidebar.close()
     */
    function closeHistorySidebar() {
        historySidebar.close();
    }

    /**
     * æ¸²æŸ“å†å²æ—¥æŠ¥åˆ—è¡¨
     * @deprecated è¯·ä½¿ç”¨ historySidebar.renderList()
     */
    function renderHistoryList() {
        historySidebar.renderList();
    }

    /**
     * åˆå§‹åŒ–å†å²æ—¥æŠ¥åŠŸèƒ½
     */
    async function initHistoryFeature() {
        // è·å–å†å²æ—¥æŠ¥æ•°æ®
        await fetchRecentReports();

        // æ¸²æŸ“å†å²åˆ—è¡¨
        renderHistoryList();

        // ç»‘å®šäº‹ä»¶
        const historyBtn = document.getElementById('history-btn');
        const closeBtn = document.getElementById('close-history-btn');
        const overlay = document.getElementById('overlay');

        historyBtn.addEventListener('click', showHistorySidebar);
        closeBtn.addEventListener('click', closeHistorySidebar);
        overlay.addEventListener('click', closeHistorySidebar);

        // ESCé”®å…³é—­ä¾§è¾¹æ 
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                historySidebar.close();
            }
        });
    }

    /**
     * åˆå§‹åŒ–åº”ç”¨
     */
    async function initApp() {
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();

            // æ£€æŸ¥æ¸²æŸ“å™¨æ˜¯å¦åŠ è½½
            if (typeof ChatLogRenderer === 'undefined') {
                throw new Error('æ¸²æŸ“å¼•æ“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ script.js æ–‡ä»¶');
            }

            // ä» Supabase è·å–æ•°æ®
            const reportData = await fetchLatestReport();

            if (!reportData) {
                throw new Error('è·å–åˆ°çš„æ•°æ®ä¸ºç©º');
            }

            // é‡æ–°æ„å»ºå®¹å™¨ç»“æ„ï¼ˆå› ä¸º showLoading æ¸…ç©ºäº†å†…å®¹ï¼‰
            const container = document.querySelector('.container');
            container.innerHTML = TemplateFactory.createReportLayout();

            // åˆå§‹åŒ–æ¸²æŸ“å™¨
            ChatLogRenderer.init(reportData);

            console.log('ğŸ‰ æ—¥æŠ¥æ¸²æŸ“å®Œæˆï¼');

            // åˆå§‹åŒ–å†å²æ—¥æŠ¥åŠŸèƒ½
            await initHistoryFeature();

        } catch (error) {
            console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            showError(error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯');
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
    document.addEventListener('DOMContentLoaded', initApp);

    /**
     * æŒ‰é’®è‡ªåŠ¨éšè—åŠŸèƒ½
     * å‘ä¸‹æ»šåŠ¨éšè—ï¼Œå‘ä¸Šæ»šåŠ¨æ˜¾ç¤º
     */
    (function() {
        let lastScrollTop = 0;
        let scrollTimer = null;
        const themeToggle = document.querySelector('.theme-toggle-wrapper');
        const historyToggle = document.querySelector('.history-toggle-wrapper');

        window.addEventListener('scroll', function() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (scrollTimer) {
                clearTimeout(scrollTimer);
            }

            // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è§¦å‘
            scrollTimer = setTimeout(function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if (scrollTop > lastScrollTop && scrollTop > 100) {
                    // å‘ä¸‹æ»šåŠ¨ä¸”è¶…è¿‡100pxï¼Œéšè—æŒ‰é’®
                    themeToggle.classList.add('hidden');
                    historyToggle.classList.add('hidden');
                } else if (scrollTop < lastScrollTop) {
                    // å‘ä¸Šæ»šåŠ¨ï¼Œæ˜¾ç¤ºæŒ‰é’®
                    themeToggle.classList.remove('hidden');
                    historyToggle.classList.remove('hidden');
                }

                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            }, 100);
        }, false);
    })();

    </script>
</body>
</html>
